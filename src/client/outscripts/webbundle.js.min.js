var __extends=this&&this.__extends||function(t,e){function o(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)},StopByStop;!function(t){!function(t){t[t.Web=0]="Web",t[t.SPA=1]="SPA"}(t.SBSApp||(t.SBSApp={}));t.SBSApp;!function(t){t[t.General=0]="General",t[t.Gas=1]="Gas",t[t.Food=2]="Food"}(t.PoiType||(t.PoiType={}));t.PoiType;!function(t){t[t.home=0]="home",t[t.route=1]="route",t[t.exit=2]="exit",t[t.about=3]="about"}(t.SBSPage||(t.SBSPage={}));t.SBSPage}(StopByStop||(StopByStop={}));var StopByStop;!function(t){!function(t){t[t.Add5MinToStop=0]="Add5MinToStop",t[t.AddStopToRoute=1]="AddStopToRoute",t[t.CityDropdownClick=2]="CityDropdownClick",t[t.FilterButtonClick=3]="FilterButtonClick",t[t.FilterMaxDistanceFromJunctionChanged=4]="FilterMaxDistanceFromJunctionChanged",t[t.FilterShowGasStationsChanged=5]="FilterShowGasStationsChanged",t[t.FilterShowRestaurantsChanged=6]="FilterShowRestaurantsChanged",t[t.LocationIN=7]="LocationIN",t[t.LocationOUT=8]="LocationOUT",t[t.LocationOUTPopupDisplayed=9]="LocationOUTPopupDisplayed",t[t.POIGroupPageScroll=10]="POIGroupPageScroll",t[t.POIGroupSwitchList=11]="POIGroupSwitchList",t[t.POIGroupSwitchMap=12]="POIGroupSwitchMap",t[t.Remove5MinFromStop=13]="Remove5MinFromStop",t[t.RemoveStopFromRoute=14]="RemoveStopFromRoute",t[t.RoutePageScroll=15]="RoutePageScroll",t[t.RoutePlanNavigateClick=16]="RoutePlanNavigateClick",t[t.RoutePlanNavigateBeforeDirect=17]="RoutePlanNavigateBeforeDirect",t[t.ShowStopSettingsPopup=18]="ShowStopSettingsPopup",t[t.SideBarThumbTouch=19]="SideBarThumbTouch",t[t.SocialButtonClick=20]="SocialButtonClick",t[t.StopPopupNavigateClick=21]="StopPopupNavigateClick",t[t.StopPopupNavigateBeforeDirect=22]="StopPopupNavigateBeforeDirect",t[t.TelLinkClick=23]="TelLinkClick",t[t.ViewTripButtonClick=24]="ViewTripButtonClick",t[t.YelpLinkClick=25]="YelpLinkClick"}(t.TelemetryEvent||(t.TelemetryEvent={}));var e=t.TelemetryEvent;!function(t){t[t.FilterVisibility=0]="FilterVisibility",t[t.LoadStopsFromCache=1]="LoadStopsFromCache",t[t.PageName=2]="PageName",t[t.StopCount=3]="StopCount",t[t.NavigationUrl=4]="NavigationUrl"}(t.TelemetryProperty||(t.TelemetryProperty={}));var o=t.TelemetryProperty;!function(t){}(t.TelemetryMeasurement||(t.TelemetryMeasurement={}));var i=t.TelemetryMeasurement,n=function(){function n(){}return n.trackPageView=function(t,e,o,i,a,r){void 0===i&&(i=null),void 0===a&&(a=null),void 0===r&&(r=!1);try{var s=n.getAIProperties(i),p=n.getAIMeasurements(a);n._appInsights.trackPageView(t,e,s,p,o),r&&n._appInsights.flush()}catch(t){n.logFatal(t)}},n.trackEvent=function(t,o,i,a){void 0===o&&(o=null),void 0===i&&(i=null),void 0===a&&(a=!1);try{var r=n.getAIProperties(o),s=n.getAIMeasurements(i);n._appInsights.trackEvent(e[t],r,s),a&&n._appInsights.flush()}catch(t){n.logFatal(t)}},n.trackError=function(t,e,o,i){void 0===e&&(e=null),void 0===o&&(o=null),void 0===i&&(i=!1);try{var a=n.getAIProperties(e),r=n.getAIMeasurements(o);n.logFatal(t),n._appInsights.trackException(t,"",a,r),i&&n._appInsights.flush()}catch(t){n.logFatal(t)}},n.logToConsole=function(t){window.console&&window.console.log(t)},n.getAIProperties=function(e){var i={};return i[o[o.PageName]]=t.AppState.current.pageInfo.telemetryPageName,e&&$.each(e,function(t,e){i[o[e.k]]=e.v}),i},n.getAIMeasurements=function(t){var e={};return t&&$.each(t,function(t,o){e[i[o.k]]=o.v}),e},n.logFatal=function(t){n.logErrorToConsole("ERROR-TO-TELEMETRY:"+t)},n.logErrorToConsole=function(t){window.console&&window.console.error&&(t.message?window.console.error(t.message):window.console.error(t))},n._appInsights=window.appInsights,n}();t.Telemetry=n}(StopByStop||(StopByStop={}));var StopByStop;!function(t){t.PAGENAME_HOME="sbs-homePG",t.PAGENAME_Route="route-page",t.PAGENAME_POIGroup="poigroup-page",t.PAGENAME_Exit="exit-page",t.PAGENAME_About="about-page",t.N_LAT_BOUNDARY=50,t.S_LAT_BOUNDARY=25,t.W_LON_BOUNDARY=-125,t.E_LON_BOUNDARY=-66,t.ROUTE_PLAN_STORAGE_KEY="sbsroutes";var e=function(){function e(){}return e.updateNavigationLocation=function(e,o){e||(e="#home"),e=e.toLowerCase();var i=e.indexOf("#"),n=null;if(i<0&&(e="#home",i=0),i>=0){var a=e.indexOf("&",i)-1;a<0?a=e.length-1:n=e.substr(a+1);var r=e.substr(i+1,a-i);if(void 0!==t.SBSPage[r]&&(o.page=t.SBSPage[r]),n)for(var s=n.split("&"),p=0;p<s.length;p++){var u=s[p].split("=");if(2===u.length){var l=u[0],c=u[1];switch(l){case"routeid":o.routeId=c,o.poiType=void 0;break;case"exitid":o.exitId=c;break;case"poitype":o.poiType=t.PoiType.General,"food"===c?o.poiType=t.PoiType.Food:"gas"===c&&(o.poiType=t.PoiType.Gas)}}}}},e.getHashFromNavigationLocation=function(e){var o="#";return o+=t.SBSPage[e.page]?t.SBSPage[e.page]:"home",e.routeId&&(o+="&routeid="+e.routeId),e.exitId&&e.page===t.SBSPage.exit&&(o+="&exitid="+e.exitId),e.poiType&&e.page===t.SBSPage.exit&&t.PoiType[e.poiType]&&(o+="&poitype="+t.PoiType[e.poiType]),o.toLowerCase()},e.getMileString=function(t){return t<.1?"<0.1mi":t.toString()+"mi"},e.getTimeString=function(t,o){return void 0===o&&(o=0),t=new Date(t.getTime()+o),e.formatTime(t)},e.formatTime=function(t){var e=t.getHours(),o=t.getMinutes(),i=o.toString(),n=e>=12?"pm":"am";return e%=12,0===e&&(e=12),o<10&&(i="0"+i),e.toString()+":"+i+" "+n},e.hasAnyOwnProperties=function(t){for(var e in t)if(t.hasOwnProperty(e))return!0;return!1},e.runOnce=function(t){var e,o=!1;return function(){for(var i=[],n=0;n<arguments.length;n++)i[n-0]=arguments[n];return o||(o=!0,e=t.apply(this,arguments)),e}},e.spaPageNavigate=function(e,o,i,n,a){void 0===a&&(a=!0);var r="#home";switch(e){case t.SBSPage.about:r="#about";break;case t.SBSPage.exit:r="#exit";break;case t.SBSPage.route:r="#route"}var s=r;o&&(s+="&routeid="+o),i&&(s+="&exitid="+i),n&&(s+="&poitype="+t.PoiType[n].toLowerCase()),t.AppState.current.knownHashChangeInProgress=!0,$.mobile.pageContainer.pagecontainer("change",r,{dataUrl:s,changeHash:a})},e.observeDOM=function(){var t=window.MutationObserver||window.WebKitMutationObserver,e=window.addEventListener;return function(o,i){if(t){var n=new t(function(t,e){(t[0].addedNodes.length||t[0].removedNodes.length)&&i()});n.observe(o,{childList:!0,subtree:!0})}else e&&(o.addEventListener("DOMNodeInserted",i,!1),o.addEventListener("DOMNodeRemoved",i,!1))}}(),e}();t.Utils=e}(StopByStop||(StopByStop={}));var StopByStop;!function(t){var e=function(){function t(){}return t.current={baseDataUrl:null,baseImageUrl:null,app:null},t}();t.AppState=e}(StopByStop||(StopByStop={}));var StopByStop;!function(t){var e=function(){function t(t,e){"string"!=typeof t?t="/":/\/$/.test(t)||(t+="/"),this.MapExitIconUrl=e+"exit_map.png",this.MapFoodIconUrl=e+"food_map2.png",this.MapGasIconUrl=e+"gas_map.png",this.BaseUrl=t,this.RouteUrl=t+"route/",this.PlacesUrl=t+"place/",this.RouteDataUrl=t+"routedata/",this.PoiUrl=t+"poi/"}return t}();t.InitUrls=e}(StopByStop||(StopByStop={}));var StopByStop;!function(t){var e=function(){function e(){}return e.wireup=function(){var e="Current location",o=null,i=function(){navigator&&navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(i){var n=i.coords.latitude,a=i.coords.longitude;n>t.S_LAT_BOUNDARY&&n<t.N_LAT_BOUNDARY&&a>t.W_LON_BOUNDARY&&a<t.E_LON_BOUNDARY?(o={n:e,i:n.toFixed(5)+","+a.toFixed(5)},$("#from").val(e),$("#from").data({place:o}),t.Telemetry.trackEvent(t.TelemetryEvent.LocationIN)):t.Telemetry.trackEvent(t.TelemetryEvent.LocationOUT)},function(e){var o="UNAVAILABLE";switch(e.code){case e.PERMISSION_DENIED:o="PERMISSION_DENIED";break;case e.POSITION_UNAVAILABLE:o="POSITION_UNAVAILABLE";break;case e.TIMEOUT:o="TIMEOUT"}t.Telemetry.trackError(new Error("getCurrentPositionErrorHomePage-"+o))},{maximumAge:6e4,timeout:5e3,enableHighAccuracy:!0})};i(),$(".input-wrapper input").on("keyup",function(i,n){var a=$(this).closest(".input-wrapper"),r=this,s=a.find("ul"),p=$(this),u=p.val();u&&(a.append("<div class='ui-loader'><span class='ui-icon ui-icon-loading'></span></div>"),$.ajax({url:t.AppState.current.urls.PlacesUrl+u,dataType:"json",method:"GET",success:function(t){a.find(".ui-loader").remove(),s.empty();var i="from"===$(r).attr("id")?$("#to"):$("#from"),n=null;if(i.data("place")&&(n=i.data("place").i),"from"===$(r).attr("id")&&o){var p=$('<li data-icon="false"><a href="#">'+e+"</a></li>");p.data("place",o),s.append(p)}for(var u=0;u<t.length;u++)if(t[u].i!==n){var p=$('<li data-icon="false"><a href="#">'+t[u].n+"</a></li>");p.data("place",t[u]),s.append(p)}s.listview("refresh"),s.trigger("updatelayout")}}))}),$(".autocomplete").on("click","li",function(e){var o=$(this).closest("div").find("input"),i=$(this).data("place");i&&(o.val(i.n).data("place",i),$(this).closest("ul").empty(),$("#from").data("place")&&$("#to").data("place")&&$("#view_trip").removeClass("ui-disabled")),t.Telemetry.trackEvent(t.TelemetryEvent.CityDropdownClick)}),$(".input-wrapper input").on("focus",function(t){var e=$(this);window.setTimeout(function(){e.select()},100);var o=$(this).closest(".input-wrapper");o.find("ul").show(),o.find(".input-tip").hide()}),$(".view-trip").on("click",function(e){t.Telemetry.trackEvent(t.TelemetryEvent.ViewTripButtonClick,null,null,!0);var o=$("#from"),i=$("#to"),n=o.data("place"),a=i.data("place");if(void 0!=n&&void 0!=a)if(t.AppState.current.app===t.SBSApp.Web){var r=t.AppState.current.urls.RouteUrl+n.i+"-to-"+a.i;$("#view_trip").addClass("ui-disabled"),window.location.assign(r)}else t.Utils.spaPageNavigate(t.SBSPage.route,n.i+"-to-"+a.i)}),$("#from").data("place")&&$("#to").data("place")&&$("#view_trip").removeClass("ui-disabled")},e}();t.InitHome=e}(StopByStop||(StopByStop={}));var StopByStop;!function(t){var e=function(){function t(t){this._obj=t,this.sbsid=this._obj.id,this.type=this._obj.t,this.yid=this._obj.yid,this.parentIDs=this._obj.p,this.name=this._obj.n}return t}();t.PoiCategoryViewModel=e}(StopByStop||(StopByStop={}));var StopByStop;!function(t){var e=function(){function e(e){var o=this;this.itemKey="sbsfilters",this.storage=sessionStorage,this.data={d:"3",g:!0,r:!0,drc:[]},this.itemKey=this.itemKey+e.routeId;var i=this.storage.getItem(this.itemKey);if(i)try{this.data=JSON.parse(i)}catch(e){t.Telemetry.trackError(new Error(e.toString()))}e.maxDistanceFromJunction(this.data.d);for(var n=[[e.maxDistanceFromJunctionIs1,"1"],[e.maxDistanceFromJunctionIs2,"2"],[e.maxDistanceFromJunctionIs3,"3"],[e.maxDistanceFromJunctionIs4,"4"],[e.maxDistanceFromJunctionIs5,"5"]],a=0;a<n.length;a++)n[a][0](n[a][1]===this.data.d);e.maxDistanceFromJunction.subscribe(function(e){o.data.d=e,o.saveData(),t.Telemetry.trackEvent(t.TelemetryEvent.FilterMaxDistanceFromJunctionChanged)}),e.showGasStations(this.data.g),e.showRestaurants(this.data.r),e.preserveShowAllSettings&&(e.showGasStations.subscribe(function(e){o.data.g=e,o.saveData(),t.AppState.current.pageInfo.pageName!==t.PAGENAME_POIGroup&&t.Telemetry.trackEvent(t.TelemetryEvent.FilterShowGasStationsChanged,[{k:t.TelemetryProperty.FilterVisibility,v:e.toString()}])}),e.showRestaurants.subscribe(function(e){o.data.r=e,o.saveData(),t.AppState.current.pageInfo.pageName!==t.PAGENAME_POIGroup&&t.Telemetry.trackEvent(t.TelemetryEvent.FilterShowRestaurantsChanged,[{k:t.TelemetryProperty.FilterVisibility,v:e.toString()}])})),$.each(e.foodCategoriesEnablement(),function(t,e){var i=e;o.data.drc.indexOf(e.category.sbsid)>-1&&i.visible(!1),i.visible.subscribe(function(t){var e=i.category.sbsid,n=o.data.drc.indexOf(e);t?n>-1&&(o.data.drc.splice(n,1),o.saveData()):n<0&&(o.data.drc.push(e),o.saveData())})})}return e.prototype.saveData=function(){this.storage.setItem(this.itemKey,JSON.stringify(this.data))},e}(),o=function(){function o(o,i,n,a,r){var s=this;void 0===r&&(r=!0),this.allCategories={},this.foodCategoriesEnablementLookup={},this.allRestaurantCategoriesSelected=ko.observable(!1),this.routeId=o,this.routeJunctions=i,this.preserveShowAllSettings=r,this.showGasStations=ko.observable(!0),this.showRestaurants=ko.observable(!0),this.foodCategoriesEnablement=ko.observableArray([]),n.sort(function(t,e){return e.c-t.c});for(var p=0;p<n.length;p++){var u=n[p],l=new t.PoiCategoryViewModel(u.cat);if(this.allCategories[l.sbsid]=l,a.indexOf(l.sbsid)>-1){var c=this.createCategoryEnablement(u);this.foodCategoriesEnablement.push(c),this.foodCategoriesEnablementLookup[c.category.sbsid]=c}}this.maxDistanceFromJunction=ko.observable("3"),this.maxDistanceFromJunctionIs1=ko.observable(!1),this.maxDistanceFromJunctionIs2=ko.observable(!1),this.maxDistanceFromJunctionIs3=ko.observable(!0),this.maxDistanceFromJunctionIs4=ko.observable(!1),this.maxDistanceFromJunctionIs5=ko.observable(!1);for(var h=[[this.maxDistanceFromJunctionIs1,"1"],[this.maxDistanceFromJunctionIs2,"2"],[this.maxDistanceFromJunctionIs3,"3"],[this.maxDistanceFromJunctionIs4,"4"],[this.maxDistanceFromJunctionIs5,"5"]],p=0;p<h.length;p++){var d=h[p];d[0].subscribe(function(t){var e=arguments[0],o=arguments[1];if(o){this.maxDistanceFromJunction(e[1]);for(var i=0;i<h.length;i++)h[i][1]!==e[1]&&h[i][0](!1)}}.bind(this,d))}this.filteredFoodCount=ko.observable(1),this.filteredGasStationCount=ko.observable(1),t.AppState.current.app===t.SBSApp.Web&&(this.filterCacheManager=new e(this));this.selectAllFoodCategories=function(){$.each(s.foodCategoriesEnablement(),function(t,e){return e.visible(!0)}),s.allRestaurantCategoriesSelected(!0)},this.unselectAllFoodCategories=function(){$.each(s.foodCategoriesEnablement(),function(t,e){return e.visible(!1)}),s.allRestaurantCategoriesSelected(!1)},this.updateFilteredCounts(),this.maxDistanceFromJunction.subscribe(function(t){return s.updateFilteredCounts()})}return o.prototype.selectAllFoodCategories=function(){},o.prototype.unselectAllFoodCategories=function(){},o.prototype.getCategoryName=function(t){return this.allCategories[t]?this.allCategories[t].name:""},o.prototype.isFoodCategoryVisible=function(t){if(this.foodCategoriesEnablementLookup[t])return this.foodCategoriesEnablementLookup[t].visible();if(this.allCategories[t]&&this.allCategories[t].parentIDs.length>0){for(var e=0;e<this.allCategories[t].parentIDs.length;e++){var o=this.isFoodCategoryVisible(this.allCategories[t].parentIDs[e]);if(o)return!0}return!1}return!0},o.prototype.updateFilteredCounts=function(){var e=this,o=0,i=0,n=parseInt(this.maxDistanceFromJunction());$.each(this.foodCategoriesEnablement(),function(t,e){return e.tempCount=0});for(var a=0;a<this.routeJunctions.length;a++)for(var r=this.routeJunctions[a],s=0;s<r.j.p.length;s++){var p=r.j.p[s];p.dfj<=n&&(p.p.pt===t.PoiType.Food?(o++,$.each(p.p.c,function(t,o){e.foodCategoriesEnablementLookup[o]&&e.foodCategoriesEnablementLookup[o].tempCount++})):p.p.pt===t.PoiType.Gas&&i++)}$.each(this.foodCategoriesEnablement(),function(t,e){e.count(e.tempCount)}),this.foodCategoriesEnablement.sort(function(t,e){return e.count()-t.count()}),this.filteredFoodCount(o),this.filteredGasStationCount(i)},o.prototype.createCategoryEnablement=function(e){var o={category:new t.PoiCategoryViewModel(e.cat),count:ko.observable(e.c),tempCount:0,visible:ko.observable(!0)};return o},o}();t.FilterViewModel=o}(StopByStop||(StopByStop={}));var StopByStop;!function(t){var e=function(){function t(t){this._obj=t,this.imageUrl=ko.observable(this._obj.u)}return t}();t.PoiImageViewModel=e}(StopByStop||(StopByStop={}));var StopByStop;!function(t){var e=function(){function t(t){this.lat=t.a,this.lon=t.o,this.placeDescription=t.pd||""}return t.getGridLocations=function(e){var o=new t({a:t.roundToNLat(e.a),o:t.roundToWLon(e.o)}),i=new t({a:o.lat+t.GRAIN,o:o.lon-t.GRAIN}),n=new t({a:o.lat+t.GRAIN,o:o.lon}),a=new t({a:o.lat+t.GRAIN,o:o.lon+t.GRAIN}),r=new t({a:o.lat,o:o.lon+t.GRAIN}),s=new t({a:o.lat-t.GRAIN,o:o.lon+t.GRAIN}),p=new t({a:o.lat-t.GRAIN,o:o.lon}),u=new t({a:o.lat-t.GRAIN,o:o.lon-t.GRAIN}),l=new t({a:o.lat,o:o.lon-t.GRAIN});return[o,i,n,a,r,s,p,u,l]},t.roundToNLat=function(e){var o=t.round1DecimalDigit(e);return o<e&&(o+=.1),o},t.roundToWLon=function(e){var o=t.round1DecimalDigit(e);return o>e&&(o-=.1),o},t.round1DecimalDigit=function(t){return Math.round(10*t)/10},t.GRAIN=.1,t}();t.LocationViewModel=e}(StopByStop||(StopByStop={}));var StopByStop;!function(t){var e=function(){function t(t){this._obj=t,this.name=ko.observable(this._obj.n),this.icon=ko.observable(this._obj.i),this.reviewCount=ko.observable(this._obj.rc),this.reviewPageUrl=ko.observable(this._obj.u),this.ratingImageUrl=ko.observable(this._obj.riu),this.rating=ko.observable(this._obj.r)}return t}();t.ReviewGroupViewModel=e}(StopByStop||(StopByStop={}));var StopByStop;!function(t){var e=function(){function e(e){this._obj=e,this.sbsid=this._obj.id,this.poiCategoryIDs=this._obj.c,this.poiType=this._obj.pt,this.name=this._obj.n,this.description=ko.observable(this._obj.d),this.location=new t.LocationViewModel(this._obj.l),this.visible=ko.observable(!0),this.telPhoneString="",0===this.sbsid.indexOf("y_")&&(this.telPhoneString=this.sbsid.substr(2)),this.isYInfoLoading=ko.observable(!0),this.yUrl=ko.observable("#"),this.yStarClass=ko.observable("stars_0"),this.yReviewCountString=ko.observable("")}return e.prototype.updateYInfo=function(t){t.rg&&t.rg.length>0&&(this.yUrl(t.rg[0].u),this.yStarClass(e.getYStarClass(t.rg[0].r)),this.yReviewCountString(e.getReviewsString(t.rg[0].rc)),this.isYInfoLoading(!1))},e.getReviewsString=function(t){return 0===t?"no reviews":1===t?"1 review":t.toString()+" reviews"},e.getYStarClass=function(t){var e=null;switch(t.toString()){case"5":e="stars_5";break;case"4.5":e="stars_4_half";break;case"4":e="stars_4";break;case"3.5":e="stars_3_half";break;case"3":e="stars_3";break;case"2.5":e="stars_2_half";break;case"2":e="stars_2";break;case"1.5":e="stars_1_half";break;case"1":e="stars_1";break;case"0":e="stars_0"}return e},e}();t.PoiViewModel=e}(StopByStop||(StopByStop={}));var StopByStop;!function(t){var e=function(){function e(e,o,i){this._obj=e,this._app=i,this.id=this._obj.id,this.dfe=this._obj.dfj,this.dtefrs=o.dfrs,this.exitId=o.j.oid.toString(),this.distanceFromJunctionText=t.Utils.getMileString(this.dfe)+" miles from exit",this.poi=new t.PoiViewModel(this._obj.p),this.name=this.poi.name,this.lat=this.poi.location.lat,this.lon=this.poi.location.lon,this.type=e.p.pt}return e.prototype.addToRouteOptionsClick=function(){var t=this._app.routePlan.getOrCreateStop(this);this._app.routePlan.showStopSettings(t)},e}();t.PoiOnJunctionViewModel=e}(StopByStop||(StopByStop={}));var StopByStop;!function(t){var e=function(){function e(e){var o=this;this.stopPlace=e,this.sbsid=e.id,this.location=new t.LocationViewModel({a:e.lat,o:e.lon}),this.name=e.name,this.stopDurationFastUpdate=ko.observable(e.duration||15),this.stopDuration=ko.observable(e.duration||15),this.stopDuration.extend({rateLimit:{timeout:1e3,method:"notifyWhenChangesStop"}}),this.exitEta=ko.observable(new Date),this.etaString=ko.computed(function(){var e=o.getDrivingTimeToPlaceInSeconds(),i=new Date(o.exitEta().getTime()+1e3*e),n=new Date(i.getTime()+60*o.stopDuration()*1e3);return t.Utils.getTimeString(i)+"-"+t.Utils.getTimeString(n)}),this.stopDurationHours=ko.computed(function(){var t=Math.floor(o.stopDurationFastUpdate()/60).toString();return 1===t.length&&(t="0"+t),t}),this.stopDurationMinutes=ko.computed(function(){var t=(o.stopDurationFastUpdate()%60).toString();return 1===t.length&&(t="0"+t),t}),this.detourDuration=ko.computed(function(){var t=2*o.getDrivingTimeToPlaceInSeconds(),e=60*o.stopDuration();return t+e})}return e.prototype.getDrivingTimeToPlaceInSeconds=function(){return this.stopPlace.dfe/20*3600},e.prototype.add5MinutesToDuration=function(){t.Telemetry.trackEvent(t.TelemetryEvent.Add5MinToStop),this.stopDurationFastUpdate(this.stopDurationFastUpdate()+5),this.stopDuration(this.stopDurationFastUpdate())},e.prototype.subtract5MinutesFromDuration=function(){t.Telemetry.trackEvent(t.TelemetryEvent.Remove5MinFromStop),this.stopDurationFastUpdate(Math.max(0,this.stopDurationFastUpdate()-5)),this.stopDuration(this.stopDurationFastUpdate())},e.prototype.navigate=function(){var e=this;t.Telemetry.trackEvent(t.TelemetryEvent.StopPopupNavigateClick,null,null,!0),navigator&&navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(o){var i=o.coords.latitude,n=o.coords.longitude,a="http://maps.google.com/maps?saddr="+i+","+n+"&daddr="+e.location.lat.toString()+","+e.location.lon.toString();t.Telemetry.trackEvent(t.TelemetryEvent.StopPopupNavigateBeforeDirect,[{k:t.TelemetryProperty.NavigationUrl,v:a}],null,!0),window.location.assign(a)},function(e){try{t.Telemetry.trackError(new Error("getCurrentPositionError"))}catch(t){}window.alert("Please allow StopByStop.com to share your location.")})},e}();t.RouteStopViewModel=e}(StopByStop||(StopByStop={}));var StopByStop;!function(t){var e=function(){function e(e,o){if(this.poiLookup={},this._obj=e.j,this._app=o,this.name=this._obj.n,this.index=this._obj.i,this.osmid=this._obj.oid,this.highwayName=this._obj.hn,this.ref=this._obj.r,this.location=new t.LocationViewModel(this._obj.l),this.exitTo=this._obj.et,this.exitToLeft=this._obj.etl,this.exitToRight=this._obj.etr,this._obj.p){this.pois=ko.observableArray();for(var i=0;i<this._obj.p.length;i++){var n=new t.PoiOnJunctionViewModel(this._obj.p[i],e,this._app);this.pois.push(n),this.poiLookup[n.id]=n}}this.pois.sort(function(t,e){return t.dfe-e.dfe})}return e}();t.JunctionViewModel=e}(StopByStop||(StopByStop={}));var StopByStop;!function(t){var e=function(){function e(e,o,i){var n=this;if(this._obj=this.routeJunction=e,this.distanceFromRouteStartText=ko.observable(t.Utils.getMileString(this._obj.dfrs)),this.junction=new t.JunctionViewModel(this._obj,i),this.visible=ko.observable(!0),this.top=ko.observable(""),this.visibleGasPois=ko.observableArray([]),this.visibleFoodPois=ko.observableArray([]),this.closestFoodPoiDistance=ko.observable(""),this.closestGasPoiDistance=ko.observable(""),this.gasPoiCountString=ko.observable(""),this.foodPoiCountString=ko.observable(""),this.stops=ko.observableArray(),this.etaWithoutStops=new Date(o.getTime()+1e3*this._obj.tfrs),this.eta=ko.observable(this.etaWithoutStops),this.hasStops=ko.computed(function(){return n.stops().length>0}),i.title&&i.title()){var a=i.title();a=a.substr(0,1).toLowerCase()+a.substr(1),this.title=this.junction.name+" on the way from "+a}this.description=ko.computed(function(){return n.junction.name+". "+n.gasPoiCountString()+" gas stations, "+n.foodPoiCountString()+" restaurants within 5 mile travel distance."}),this.etaString=ko.computed(function(){var e=t.Utils.getTimeString(n.eta());return n.hasStops()&&(e=t.Utils.getTimeString(n.eta())+"-"+t.Utils.getTimeString(n.etd())),e}),this.etd=ko.computed(function(){for(var t=0,e=0;e<n.stops().length;e++)t+=n.stops()[e].detourDuration();return new Date(n.eta().getTime()+1e3*t)})}return e.prototype.applyFilter=function(e){this.visibleGasPois.removeAll(),this.visibleFoodPois.removeAll();for(var o=0;o<this.junction.pois().length;o++){var i=this.junction.pois()[o];i.poi.visible(!1);var n=parseInt(e.maxDistanceFromJunction(),10);if(i.poi.poiType===t.PoiType.Food&&e.showRestaurants()&&i.dfe<=n){var a=i.poi.poiCategoryIDs;if(a&&a.length>0){for(var r=0;r<a.length;r++)if(e.isFoodCategoryVisible(a[r])){this.visibleFoodPois().push(i),i.poi.visible(!0);break}}else this.visibleFoodPois().push(i),i.poi.visible(!0)}else i.poi.poiType===t.PoiType.Gas&&e.showGasStations()&&i.dfe<=n&&(this.visibleGasPois().push(i),i.poi.visible(!0))}this.visible(this.visibleFoodPois().length>0||this.visibleGasPois().length>0),this.closestFoodPoiDistance(this.visibleFoodPois().length>0?t.Utils.getMileString(this.visibleFoodPois()[0].dfe):""),this.closestGasPoiDistance(this.visibleGasPois().length>0?t.Utils.getMileString(this.visibleGasPois()[0].dfe):""),this.gasPoiCountString(this.visibleGasPois().length>9?"9+":this.visibleGasPois().length.toString()),this.foodPoiCountString(this.visibleFoodPois().length>9?"9+":this.visibleFoodPois().length.toString())},e.prototype.navigateToExitPage=function(){t.Utils.spaPageNavigate(t.SBSPage.exit,t.AppState.current.navigationLocation.routeId,this.junction.osmid.toString())},e.prototype.navigateToExitFoodPage=function(){t.Utils.spaPageNavigate(t.SBSPage.exit,t.AppState.current.navigationLocation.routeId,this.junction.osmid.toString(),t.PoiType.Food)},e.prototype.navigateToExitGasPage=function(){t.Utils.spaPageNavigate(t.SBSPage.exit,t.AppState.current.navigationLocation.routeId,this.junction.osmid.toString(),t.PoiType.Gas)},e}();t.RouteJunctionViewModel=e}(StopByStop||(StopByStop={}));var StopByStop;!function(t){var e=function(){function e(t,e,o,i){void 0===i&&(i=null),this._stopDictionary={},this._storage=window.sessionStorage,this._storageItem={},this.junctionMap={},this.routeDistance=e,this._storage=i||window.sessionStorage,this._routeId=t,this.stops=ko.observableArray([]),this.editedStop=ko.observable(null),this._stopDictionary={},this._destination=o}return e.prototype.loadStopsFromStorage=function(){if(this.stops([]),this._stopDictionary={},this._storage.getItem(t.ROUTE_PLAN_STORAGE_KEY)?this._storageItem=JSON.parse(this._storage.getItem(t.ROUTE_PLAN_STORAGE_KEY)):this._storageItem={},this._storageItem[this._routeId]){var e=this._storageItem[this._routeId].stops;for(var o in e){var i=this.getOrCreateStop(e[o]);this.addStopToRoute(i,!0)}}else this._storageItem[this._routeId]={stops:{}};this.saveRouteToStorage()},e.prototype.getOrCreateStop=function(e,o){void 0===o&&(o=!1);var i={dfe:e.dfe,dtefrs:e.dtefrs,duration:e.duration,exitId:e.exitId,id:e.id,lat:e.lat,lon:e.lon,name:e.name,type:e.type||t.PoiType.Food},n=i.id;if(!this._stopDictionary[n]){var a=new t.RouteStopViewModel(i);this._stopDictionary[n]=a}var r=this._stopDictionary[n];return r},e.prototype.addEditedStopToRoute=function(){this.addStopToRoute(this.editedStop()),t.Utils.spaPageNavigate(t.SBSPage.route,t.AppState.current.navigationLocation.routeId)},e.prototype.removeEditedStop=function(){this.removeStop(this.editedStop()),this.closeStopSettings()},e.prototype.navigateToEditedStop=function(){this.editedStop().navigate()},e.prototype.addStopToRoute=function(e,o){var i=this;void 0===o&&(o=!1),t.Telemetry.trackEvent(t.TelemetryEvent.AddStopToRoute,[{k:t.TelemetryProperty.LoadStopsFromCache,v:o.toString()}]);var n=e.stopPlace,a=!1;if($.each(this.stops(),function(t,e){e.sbsid===n.id&&(a=!0)}),!a){this.stops.push(this._stopDictionary[n.id]);var r=this.junctionMap[n.exitId];if(r?r.stops.push(e):t.Telemetry.trackError(new Error("RouteStopViewModel.addStopToRoute.0"),null,null),t.AppState.current.app===t.SBSApp.Web){if("route-page"===t.AppState.current.pageInfo.pageName){var r=this.junctionMap[n.exitId];r?r.stops.push(e):alert("Couldn't find routeJunctionViewModel")}n.duration=e.stopDuration(),this._storageItem[this._routeId].stops[n.id]=n,e.stopDuration.subscribe(function(t){i._storageItem[i._routeId].stops[n.id].duration=t,i.saveRouteToStorage()}),this.saveRouteToStorage()}}},e.prototype.removeStop=function(e){t.Telemetry.trackEvent(t.TelemetryEvent.RemoveStopFromRoute);var o=e.sbsid;if(this._stopDictionary[o]){var e=this._stopDictionary[o];this.stops.remove(e);var i=this.junctionMap[e.stopPlace.exitId];i&&i.stops.remove(e),delete this._stopDictionary[o],t.AppState.current.app===t.SBSApp.Web&&(delete this._storageItem[this._routeId].stops[o],this.saveRouteToStorage())}},e.prototype.showStopSettings=function(e){t.Telemetry.trackEvent(t.TelemetryEvent.ShowStopSettingsPopup),this.editedStop(e);var o=t.AppState.current.app===t.SBSApp.SPA?$("."+t.AppState.current.pageInfo.pageName+" .stop-settings-dialog"):$("#stopSettingsDialog");o.popup({transition:"slidedown",corners:!0}),ko.tasks.runEarly(),o.trigger("create"),o.popup("open")},e.prototype.closeStopSettings=function(){var e=t.AppState.current.app===t.SBSApp.SPA?$("."+t.AppState.current.pageInfo.pageName+" .stop-settings-dialog"):$("#stopSettingsDialog");e.popup("close")},e.prototype.navigate=function(){var e=this;t.Telemetry.trackEvent(t.TelemetryEvent.RoutePlanNavigateClick,null,null,!0),this._destination&&navigator&&navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(o){for(var i=o.coords.latitude,n=o.coords.longitude,a="",r=0;r<e.stops().length;r++)r>0&&(a+="+to:"),a+=e.stops()[r].location.lat+","+e.stops()[r].location.lon;""!==a&&(a+="+to:"),a+=e._destination.lat+","+e._destination.lon;var s="http://maps.google.com/maps?saddr="+i+","+n+"&daddr="+a;t.Telemetry.trackEvent(t.TelemetryEvent.RoutePlanNavigateBeforeDirect,[{k:t.TelemetryProperty.StopCount,v:e.stops().length.toString()},{k:t.TelemetryProperty.NavigationUrl,v:s}],null,!0),window.location.assign(s)},function(e){t.Telemetry.trackError(new Error("getCurrentPositionError")),window.alert("Please allow StopByStop.com to share your location.")})},e.prototype.saveRouteToStorage=function(){t.AppState.current.app===t.SBSApp.Web&&this._storage.setItem(t.ROUTE_PLAN_STORAGE_KEY,JSON.stringify(this._storageItem))},e}();t.RoutePlanViewModel=e}(StopByStop||(StopByStop={}));var StopByStop;!function(t){var e=function(){function e(o,i,n){var a=this;if(this._obj=o,this._app=n,this.highwayNameText=ko.observable(""),this._obj.r?(this.highwayNameText(this._obj.r),this._obj.hn&&this._obj.hn!==this._obj.r&&this.highwayNameText(this._obj.r+" - "+this._obj.hn)):this._obj.hn?this.highwayNameText(this._obj.hn):this.highwayNameText(""),this.start=ko.observable(new t.LocationViewModel(this._obj.s)),this.end=ko.observable(new t.LocationViewModel(this._obj.e)),this.distance=ko.observable(this._obj.d),this.routeJunctions=[],this._obj.j)for(var r=0;r<this._obj.j.length;r++){var s=new t.RouteJunctionViewModel(this._obj.j[r],i,this._app);this._app.routePlan.junctionMap[s.junction.osmid.toString()]=s,this.routeJunctions.push(s)}this.routeVisibleJunctions=ko.observableArray([]),this.portionCompleted=ko.observable(this._obj.pc),this.startIndex=ko.observable(this._obj.si),this.endIndex=ko.observable(this._obj.ei),this.height=ko.computed(function(){return(a.routeVisibleJunctions().length*e.SPACE_FOR_JUNCTION+e.SEGMENT_INITIAL_SPACE).toString()+"em"}),this.distanceText=ko.computed(function(){return t.Utils.getMileString(a.distance())}),this.maneuver=this._obj.m,this.instructions=this._obj.i||"",this.instructionsTip=this.instructions.replace(/(<([^>]+)>)/gi,""),this.layoutJunctions()}return e.prototype.applyFilter=function(t){this.layoutJunctions(t)},e.prototype.layoutJunctions=function(t){void 0===t&&(t=null),this.routeVisibleJunctions.removeAll();for(var o=0,i=0;i<this.routeJunctions.length;i++){var n=this.routeJunctions[i];t&&n.applyFilter(t),n.visible()&&(this.routeVisibleJunctions.push(n),n.top((e.SEGMENT_INITIAL_SPACE+o*e.SPACE_FOR_JUNCTION).toString()+"em"),o++)}},e.SEGMENT_INITIAL_SPACE=7,e.SPACE_FOR_JUNCTION=8,e}();t.RouteSegmentViewModel=e}(StopByStop||(StopByStop={}));var StopByStop;!function(t){var e=function(){function e(e,o){this.stop=e,this.routePlan=o,this.poiTypeClass=e.stopPlace.type===t.PoiType.Food?"food":"gas",this.top=ko.observable(""),this.left=ko.observable("")}return e.prototype.click=function(){this.routePlan.showStopSettings(this.stop)},e}();t.SideBarStopViewModel=e;var o=function(){function o(e,o,i){var n=this;this._headerHeight=0,this._footerHeight=0,this._thumbHeight=0,this._scrollProcessingScheduled=!1,this._thumbPageY=null,this._thumbTopAtDragStart=0,this._routeContentSelector=".route-page .ui-content",this._sideBarInit=t.Utils.runOnce(function(){$("#sidebar-thumb").unbind(),$(n._routeContentSelector).unbind(),$("#sidebar-thumb").bind("touchstart mousedown",function(t){n.onTouchStart(t)}),$("#sidebar-thumb").bind("touchend mouseup",function(t){n.onTouchEnd(t)}),$(n._routeContentSelector).bind("mousemove",function(t){n.onTouchMove(t,t.pageY)}),$(n._routeContentSelector).bind("touchmove",function(t){n.onTouchMove(t,t.originalEvent.touches[0].pageY)})}),this._sideBarFirstScrollInit=t.Utils.runOnce(this.sideBarFirstScrollInit.bind(this)),this.sideBarHeight=ko.observable(0),this.sideBarInnerHeight=ko.observable(0),this.sideBarInnerTop=ko.observable(0),this.sideBarPosition=ko.observable("absolute"),
this.sideBarTop=ko.observable("40px"),this.sideBarBottom=ko.observable(""),this.sideBarThumbTop=ko.observable("0px"),this.isDraggingThumb=ko.observable(!1),this.stops=ko.observableArray([]),this._routePlanViewModel=e,this._routeViewModel=o,$(document).scroll(function(){n._scrollProcessingScheduled||(window.setTimeout(function(){n.onScroll(),n._scrollProcessingScheduled=!1},20),n._scrollProcessingScheduled=!0)}),i.app===t.SBSApp.Web&&this.postInit()}return o.prototype.postInit=function(){this._sideBarInit()},o.prototype.onTouchStart=function(e){t.Telemetry.trackEvent(t.TelemetryEvent.SideBarThumbTouch),this.isDraggingThumb(!0),this._thumbTopAtDragStart=parseInt(this.sideBarThumbTop()),e.preventDefault()},o.prototype.onTouchEnd=function(t){if(this.isDraggingThumb()){this._thumbPageY=null,this.isDraggingThumb(!1);var e=parseInt(this.sideBarThumbTop()),o=e-this._thumbTopAtDragStart,i=$(".route").innerHeight()/(this.sideBarInnerHeight()-this._thumbHeight)*o;window.scrollBy(0,i),t.preventDefault()}},o.prototype.onTouchMove=function(t,e){if(this.isDraggingThumb()){if(this._thumbPageY){var o=parseInt(this.sideBarThumbTop()),i=o+(e-this._thumbPageY);i=Math.max(0,i),i=Math.min(this.sideBarInnerHeight()-this._thumbHeight,i),this.sideBarThumbTop(i.toString()+"px")}this._thumbPageY=e,t.preventDefault()}},o.prototype.onScroll=function(){this._sideBarFirstScrollInit();var t=$(document).scrollTop(),e=$(this._routeContentSelector).offset().top;t>e?(this.sideBarPosition("fixed"),this.sideBarTop(""),this.sideBarBottom(this._footerHeight.toString()+"px"),this._portionOfRouteScrolled=Math.min(1,(t-e)/($(".route").innerHeight()-$(window).height()-this._footerHeight)),this.recalcThumbPosition()):(this.sideBarPosition("absolute"),this.sideBarTop("40px"),this.sideBarBottom(""),this.sideBarThumbTop("0px"))},o.prototype.recalcThumbPosition=function(){this.sideBarThumbTop(((this.sideBarInnerHeight()-this._thumbHeight)*this._portionOfRouteScrolled).toString()+"px")},o.prototype.sideBarFirstScrollInit=function(){var e=this;t.Telemetry.trackEvent(t.TelemetryEvent.RoutePageScroll),o.recalculateSideBarPosition(this),o._recalcOnWindowResize&&$(window).off("resize",o._recalcOnWindowResize),o._recalcOnWindowResize=o.recalculateSideBarPosition.bind(this),$(window).on("resize",o._recalcOnWindowResize),this._routePlanViewModel.stops.subscribe(function(){return e.updateStopsOnSidebar()}),this._routeViewModel.roadLineHeight.subscribe(function(){return e.updateStopsOnSidebar()})},o.prototype.updateStopsOnSidebar=function(){var o=this;this.stops.removeAll();var i=$.map(this._routePlanViewModel.stops(),function(t,i){return new e(t,o._routePlanViewModel)});if(i.length>0&&t.Utils.hasAnyOwnProperties(this._routeViewModel.routeJunctionElementLookup)){i.sort(function(t,e){return t.stop.stopPlace.dtefrs-e.stop.stopPlace.dtefrs});for(var n="",a=0,r=0;r<i.length;r++){var s=i[r],p=s.stop.stopPlace.exitId;if(this._routeViewModel.routeJunctionElementLookup[p]){p===n?a++:(a=0,n=p);var u=this.sideBarInnerHeight()-32,l=u*this._routeViewModel.routeJunctionElementLookup[p].top*1.15/this._routeViewModel.roadLineHeight();s.top(l.toString()+"px"),s.left((-28+8*a).toString()+"px"),this.stops.push(s)}}}t.Telemetry.logToConsole(i.length.toString()+" stops on sidebar updated")},o.recalculateSideBarPosition=function(e){t.AppState.current.app===t.SBSApp.Web?(e._headerHeight=$(".ui-header").outerHeight(),e._footerHeight=$(".ui-footer").outerHeight()):(e._headerHeight=$("."+t.AppState.current.pageInfo.pageName+" .ui-header").outerHeight(),e._footerHeight=$("."+t.AppState.current.pageInfo.pageName+" .ui-footer").outerHeight()),e._thumbHeight=$("#sidebar-thumb").outerHeight();var o=$(".sidebar-top").outerHeight(),i=$(".sidebar-bottom").outerHeight(),n=window.innerHeight?window.innerHeight:$(window).height(),a=n-e._headerHeight-e._footerHeight,r=a-i-o;e.sideBarHeight(a),e.sideBarInnerHeight(r),e.sideBarInnerTop(o),e.recalcThumbPosition(),e.updateStopsOnSidebar()},o}();t.SideBarViewModel=o}(StopByStop||(StopByStop={}));var StopByStop;!function(t){var e=function(){function e(e,o,i,n,a){var r=this;this._stopDurationSubscriptions=[],this._junctionElementCount=0,this._subscribedForBoundElement=!1,this.routeJunctionElementLookup={},this.roadLineHeight=ko.observable(0),this.routeHeightPx=ko.observable(0),this.boundElement=ko.observable(null),this._route=this.route=e,this._app=o,this._routeInitializationComplete=a,this._filter=i,this.sideBar=new t.SideBarViewModel(o.routePlan,this,n),this.fromLocation=new t.LocationViewModel(this._route.fl),this.toLocation=new t.LocationViewModel(this._route.tl),this.currentLocation=ko.observable(new t.LocationViewModel(this._route.cl)),this._routeStartTime=new Date,this.startTimeString=ko.observable(t.Utils.getTimeString(this._routeStartTime)),this.etaString=ko.observable(t.Utils.getTimeString(this._routeStartTime,1e3*this._route.t)),this.routeId=this._route.rid,this.distance=this._route.d,0===this.fromLocation.placeDescription.indexOf("Start location (")&&(this.fromLocation.placeDescription="Your location"),this.title=this.fromLocation.placeDescription+" to "+this.toLocation.placeDescription;var s=0;$.each(e.s,function(t,e){return s+=e.j.length}),this.description="Traveling by car from "+this.fromLocation.placeDescription.toString()+" to "+this.toLocation.placeDescription.toString()+" and looking for best place to stop for food or gas? This route is "+this.distance.toString()+" miles and has "+s.toString()+" exits.Check this out. ",this.shortDescription="Distance "+this.distance.toString()+". "+s.toString()+" exits",this.routeSegments=ko.observableArray([]),this.createSegmentFirstTime(0),this.boundElement=ko.observable(null),this.boundElement.subscribe(function(e){e&&!r._subscribedForBoundElement&&(r._subscribedForBoundElement=!0,r.recalcRoadLine(e),t.Utils.observeDOM(e,function(){r.recalcRoadLine(e)}))})}return e.prototype.recalcRoadLine=function(e){var o=this,i=$(e).find(".junction-wrapper"),n=i.length,a="",r=$(this.boundElement()).height();0===r||n===this._junctionElementCount&&this.roadLineHeight()===r||(this.roadLineHeight(r),this._junctionElementCount=n,this.routeJunctionElementLookup={},i.each(function(t,i){a=$(e).offset().top.toString(),o.routeJunctionElementLookup[i.getAttribute("osmid")]={top:$(i).offset().top-$(e).offset().top}}),t.Telemetry.logToConsole("recaldRoadLine: "+this.roadLineHeight()+". last junction top: "+a))},e.prototype.applyFilter=function(t){$.each(this.routeSegments(),function(e,o){return o.applyFilter(t)})},e.prototype.createSegmentFirstTime=function(e){var o=this,i=new t.RouteSegmentViewModel(this._route.s[e],this._routeStartTime,this._app);i.applyFilter(this._filter),this.routeSegments.push(i),e++,this._route.s.length>e?window.setTimeout(function(){return o.createSegmentFirstTime(e)},100):(this._routeInitializationComplete(),this.initializeEtaTimes())},e.prototype.initializeEtaTimes=function(){var t=this;this.updateEtaTimes(),this.updateStopDurationChangeSubscriptions(),this._app.routePlan.stops.subscribe(function(){t.updateEtaTimes(),t.updateStopDurationChangeSubscriptions()})},e.prototype.updateStopDurationChangeSubscriptions=function(){var t=this;$.each(this._stopDurationSubscriptions,function(t,e){e.dispose()}),$.each(this._app.routePlan.stops(),function(e,o){t._stopDurationSubscriptions.push(o.stopDuration.subscribe(function(){return t.updateEtaTimes()}))})},e.prototype.updateEtaTimes=function(){for(var e=(this._routeStartTime,0),o=0;o<this.routeSegments().length;o++)for(var i=0;i<this.routeSegments()[o].routeJunctions.length;i++){var n=this.routeSegments()[o].routeJunctions[i];n.eta(new Date(n.etaWithoutStops.getTime()+e));for(var a=0,r=0;r<n.stops().length;r++){var s=n.stops()[r];a+=1e3*s.detourDuration(),s.exitEta(n.eta())}e+=a}this.etaString(t.Utils.getTimeString(this._routeStartTime,1e3*this._route.t+e))},e}();t.RouteViewModel=e}(StopByStop||(StopByStop={}));var StopByStop;!function(t){var e=function(){function e(e,o,i){var n=this;if(void 0===o&&(o=null),void 0===i&&(i=null),this.route=null,this.url=ko.observable(""),this.title=ko.observable(""),this.filter={},this.routePlan=null,this.selectedJunction=ko.observable(null),this.url(location.toString()),e){this._route=e;var a=[];$.each(e.s,function(t,e){return a.push.apply(a,e.j)}),this.filter=new t.FilterViewModel(e.rid,a,e.fcat,e.tfcat),this.routePlan=new t.RoutePlanViewModel(this._route.rid,this._route.d,new t.LocationViewModel(e.tl)),this.route=new t.RouteViewModel(this._route,this,this.filter,o,function(){o.app===t.SBSApp.Web&&n.routePlan.loadStopsFromStorage(),i&&i()}),ko.computed(function(){return ko.toJS(n.filter)}).subscribe(function(){n.route.applyFilter(n.filter)}),this.title(this.route.title+" - Stop by Stop")}else this.title("See best places to stop on the way to your destination - Stop by Stop");window.document.title=this.title()}return e.prototype.initSideBar=function(){this.route&&this.route.sideBar&&this.route.sideBar.postInit()},e}();t.AppViewModel=e}(StopByStop||(StopByStop={})),String.prototype.f=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];for(var o=this,i=t.length;i--;)o=o.replace(new RegExp("\\{"+i+"\\}","gm"),t[i]);return o};var StopByStop;!function(t){var e=function(){function e(e,o,i,n){var a=this;this.mapDivInitialized=!1,this.junction=i,this.mapDiv=e,this.mapContainerDiv=o,this.urls=n,t.AppState.current.app===t.SBSApp.Web&&this.mapDiv&&this.mapContainerDiv&&window.setTimeout(function(){a.initMapDiv(),window.setTimeout(function(){$(a.mapContainerDiv).hide()},500)},300)}return e.prototype.initMapDiv=function(){this.mapDivInitialized||($(this.mapDiv).css({height:$(this.mapDiv).width()+"px"}),this.onMapReady(),this.mapDivInitialized=!0)},e.prototype.onMapReady=function(){var t=new google.maps.LatLng(this.junction.junction.location.lat,this.junction.junction.location.lon);this.map=new google.maps.Map(this.mapDiv,{zoom:14,center:t,disableDefaultUI:!1});new google.maps.Marker({position:t,map:this.map,icon:this.urls.MapExitIconUrl});this.createPois()},e.prototype.createPois=function(){var e=this,o=this.junction.junction.pois();$.each(o,function(o,i){var n=i,a=new google.maps.LatLng(n.poi.location.lat,n.poi.location.lon),r=new google.maps.Marker({position:a,icon:n.poi.poiType===t.PoiType.Food?e.urls.MapFoodIconUrl:e.urls.MapGasIconUrl,map:e.map});r.setVisible(n.poi.visible()),r.addListener("click",function(){if(e.poiInfoWindow&&e.poiInfoWindow.close(),ko.cleanNode($("#poiPopupTemplate")[0]),ko.applyBindings(n,$("#poiPopupTemplate")[0]),!r.iw){var t=new google.maps.InfoWindow({content:$("#poiPopupTemplate").html()});r.iw=t,n.poi.isYInfoLoading.subscribe(function(){ko.cleanNode($("#poiPopupTemplate")[0]),ko.applyBindings(n,$("#poiPopupTemplate")[0]),t.setContent($("#poiPopupTemplate").html())})}e.poiInfoWindow=r.iw,window.showPoiOptionsForMapPopup=function(){n.addToRouteOptionsClick()},e.poiInfoWindow.open(e.map,r)}),n.poi.visible.subscribe(function(t){r.setVisible(t),!t&&r.iw&&r.iw.close()})})},e}();t.JunctionMapViewModel=e}(StopByStop||(StopByStop={}));var StopByStop;!function(t){var e=function(){function e(){this._locationToLoadIndex=0}return e.prototype.loadFullPoiData=function(){var e=this;if(this._locationToLoadIndex<this._poiLocations.length){var o=this._poiLocations[this._locationToLoadIndex++],i=o.lat.toFixed(1),n=o.lon.toFixed(1);$.ajax(t.AppState.current.urls.PoiUrl+i+","+n).done(function(t){for(var o=0;o<t.length;o++){var i=t[o];e.routeJunction.junction.poiLookup[i.id]&&e.routeJunction.junction.poiLookup[i.id].poi.updateYInfo(i)}e.loadFullPoiData()})}},e}();t.JunctionAppBaseViewModel=e;var o=function(e){function o(o,i,n,a,r){var s=this;void 0===r&&(r=t.PoiType.General),e.call(this),this.routePlan=a,this.routeJunction=i,this.filter=new t.FilterViewModel(n.routeId,[this.routeJunction.routeJunction],o.fcat,o.tfcat,(!1));var p=this.routeJunction.junction.location;this._poiLocations=t.LocationViewModel.getGridLocations({a:p.lat,o:p.lon}),r===t.PoiType.Food?this.filter.showGasStations(!1):r===t.PoiType.Gas&&this.filter.showRestaurants(!1),this.loadFullPoiData(),this.routeJunction.applyFilter(this.filter),ko.computed(function(){return ko.toJS(s.filter)}).subscribe(function(){s.routeJunction.applyFilter(s.filter)})}return __extends(o,e),o.prototype.initMap=function(e,o){return this.junctionMapViewModel=new t.JunctionMapViewModel(e,o,this.routeJunction,t.AppState.current.urls),this.junctionMapViewModel},o}(e);t.JunctionSPAAppViewModel=o;var i=function(e){function o(o,i,n,a,r){var s=this;e.call(this);var p=new Date;this._routeJunction=o,this.routePlan=new t.RoutePlanViewModel(n,0,null),this.routePlan.loadStopsFromStorage(),this.filter=new t.FilterViewModel(n,[o],o.j.fcat,o.j.tfcat,(!1)),this.filter.showRestaurants(!0),this.filter.showGasStations(!0),i===t.PoiType.Food?this.filter.showGasStations(!1):i===t.PoiType.Gas&&this.filter.showRestaurants(!1),this.routeJunction=new t.RouteJunctionViewModel(this._routeJunction,p,this),this.routeJunction.applyFilter(this.filter),ko.computed(function(){return ko.toJS(s.filter)}).subscribe(function(){s.routeJunction.applyFilter(s.filter)}),this.junctionMapViewModel=new t.JunctionMapViewModel(a,r,this.routeJunction,t.AppState.current.urls),this._poiLocations=t.LocationViewModel.getGridLocations(o.j.l),this.loadFullPoiData()}return __extends(o,e),o}(e);t.JunctionAppViewModel=i}(StopByStop||(StopByStop={}));var StopByStop;!function(t){var e=function(){function e(){}return e.initialize=function(o){var i=this;t.AppState.current=o,t.AppState.current.urls=new t.InitUrls(o.baseDataUrl,o.baseImageUrl),e._app=ko.observable(new t.AppViewModel(null)),ko.options.deferUpdates=!0,e.enableUAMatch(),$(document).on("pageinit",".jqm-demos",function(o){var n=$(i);t.AppState.current.app===t.SBSApp.SPA&&e._initSPAOnce(),t.AppState.current.app===t.SBSApp.Web&&($(".jqm-navmenu-panel ul").listview(),$(".jqm-navmenu-link").on("click",function(){n.find(".jqm-navmenu-panel:not(.jqm-panel-page-nav)").panel().panel("open")})),jQuery(document).ready(function(){jQuery("#breadCrumb0").jBreadCrumb()}),$(".social-btn").click(function(){t.Telemetry.trackEvent(t.TelemetryEvent.SocialButtonClick)}),$(".filter-btn").click(function(){t.Telemetry.trackEvent(t.TelemetryEvent.FilterButtonClick)})}),$(document).on("pageinit",".sbs-homePG",function(e){t.InitHome.wireup()}),$(document).on("pageinit",".route-page",function(t){}),$(document).on("pageinit",".exit-page",function(t){}),$(document).on("pageinit",".poigroup-page",function(e){var o=!1;$(document).scroll(function(){o||(o=!0,t.Telemetry.trackEvent(t.TelemetryEvent.POIGroupPageScroll))})});var n=!1;$(window).hashchange(function(){n||(n=!0,window.setTimeout(function(){if(!t.AppState.current.knownHashChangeInProgress){var e=location.hash,o=t.AppState.current.navigationLocation.page;t.Utils.updateNavigationLocation(e,t.AppState.current.navigationLocation),o!==t.AppState.current.navigationLocation.page&&t.Utils.spaPageNavigate(t.AppState.current.navigationLocation.page,t.AppState.current.navigationLocation.routeId,t.AppState.current.navigationLocation.exitId,t.AppState.current.navigationLocation.poiType,!1)}t.AppState.current.knownHashChangeInProgress=!1,n=!1},100))}),$(window).hashchange()},e.loadRoute=function(o){var i=$.Deferred();return $.ajax({url:t.AppState.current.urls.RouteDataUrl+o,dataType:"json",method:"GET",success:function(o){var n=o,a=new t.AppViewModel(n,t.AppState.current,function(){i.resolve()});e._app(a)}}),i.promise()},e.completeExitPageInit=function(){var o=e._app().routePlan.junctionMap[t.AppState.current.navigationLocation.exitId],i=t.AppState.current.navigationLocation.poiType,n=e._app(),a=new t.JunctionSPAAppViewModel(n.route.route,o,n.filter,n.routePlan,i);n.selectedJunction(a),e.initJunctionMapWhenReady(a).then(function(t){$(".view-mode-switch").controlgroup(),$(".view-mode-switch").trigger("create"),e.wireupPOIGroup(t)}),e._app().url(location.toString()),e._app().title(a.routeJunction.title),document.title=e._app().title()},e.initSPA=function(){var o=this,i=$("#sbsRoot")[0];ko.applyBindings(e._app,i),$(".filter-btn").click(function(){return e.openFilterPopup()}),$(".jqm-navmenu-link").click(function(){return e.openNavigationMenu()});var n,a=!1;$.mobile.pageContainer.pagecontainer({beforeshow:function(e,o){a=!1,n=(new Date).getTime();var i=o.toPage.attr("id"),r="#"+i;t.AppState.current.navigationLocation||(t.AppState.current.navigationLocation={page:t.SBSPage.home}),t.Utils.updateNavigationLocation(location.hash,t.AppState.current.navigationLocation);var s=t.Utils.getHashFromNavigationLocation(t.AppState.current.navigationLocation);location.hash!==s&&(t.AppState.current.knownHashChangeInProgress=!0,location.replace(s)),t.AppState.current.pageInfo={pageName:o.toPage.data("page-name"),telemetryPageName:o.toPage.data("telemetry-page-name")};var i=o.toPage[0].id;t.SBSPage[t.AppState.current.navigationLocation.page]!==i&&(t.Utils.spaPageNavigate(t.AppState.current.navigationLocation.page,t.AppState.current.navigationLocation.routeId,t.AppState.current.navigationLocation.exitId,t.AppState.current.navigationLocation.poiType,!1),a=!0),$(r).css({paddingTop:"51px",paddingBottom:"50px"})},show:function(i,r){if(!a){switch(t.AppState.current.navigationLocation.page){case t.SBSPage.route:case t.SBSPage.exit:$(".filter-btn").show(),e._currentRouteId!==t.AppState.current.navigationLocation.routeId?(e._currentRouteId=t.AppState.current.navigationLocation.routeId,e._app(new t.AppViewModel(null)),e.loadRoute(t.AppState.current.navigationLocation.routeId).done(function(){t.AppState.current.navigationLocation.page===t.SBSPage.exit&&e.completeExitPageInit()})):(o._app().url(location.toString()),t.AppState.current.navigationLocation.page===t.SBSPage.route?(o._app().route.recalcRoadLine($(".route")[0]),o._app().title(o._app().route.shortDescription)):t.AppState.current.navigationLocation.page===t.SBSPage.exit&&e.completeExitPageInit());break;default:$(".filter-btn").hide()}t.Telemetry.trackPageView(t.AppState.current.pageInfo.telemetryPageName,"#"+t.AppState.current.pageInfo.pageName,(new Date).getTime()-n)}}})},e.initJunctionMapWhenReady=function(t){var o=jQuery.Deferred(),i=$("#map")[0],n=$(".poi-map")[0];if(i&&n){var a=t.initMap(i,n);o.resolve(a)}else window.setTimeout(function(){e.initJunctionMapWhenReady(t).then(function(t){return o.resolve(t)})},50);return o.promise()},e.wireupPOIGroup=function(e){$(".view-mode-switch").on("change",function(){var o=$(".view-mode-switch :radio:checked").val();"list"===o?($(".poi-table").show(),$(".poi-map").hide(),t.Telemetry.trackEvent(t.TelemetryEvent.POIGroupSwitchList)):($(".poi-table").hide(),$(".poi-map").show(),e.initMapDiv(),t.Telemetry.trackEvent(t.TelemetryEvent.POIGroupSwitchMap))}),$(".yelp-btn").on("click",function(){t.Telemetry.trackEvent(t.TelemetryEvent.YelpLinkClick,null,null,!0)}),$(".tel-btn").on("click",function(){t.Telemetry.trackEvent(t.TelemetryEvent.TelLinkClick)})},e.enableUAMatch=function(){var t,e;jQuery.uaMatch=function(t){t=t.toLowerCase();var e=/(chrome)[ \/]([\w.]+)/.exec(t)||/(webkit)[ \/]([\w.]+)/.exec(t)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(t)||/(msie) ([\w.]+)/.exec(t)||t.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(t)||[];return{browser:e[1]||"",version:e[2]||"0"}},t=jQuery.uaMatch(navigator.userAgent),e={},t.browser&&(e[t.browser]=!0,e.version=t.version),e.chrome?e.webkit=!0:e.webkit&&(e.safari=!0),jQuery.browser=e},e.openNavigationMenu=function(){var e=$("."+t.AppState.current.pageInfo.pageName+" .nav-menu");e.length>0&&(e.panel(),e.trigger("create"),e.panel("open"))},e.openFilterPopup=function(){var e=$("."+t.AppState.current.pageInfo.pageName+" .filter-dlg");e.length>0&&(e.popup(),e.trigger("create"),e.popup("open",{positionTo:"origin",transition:"slidedown"}))},e._initSPAOnce=t.Utils.runOnce(e.initSPA),e}();t.Init=e}(StopByStop||(StopByStop={}));